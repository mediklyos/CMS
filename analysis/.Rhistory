require(dplyr, warn.conflicts=FALSE)
require(rCharts, warn.conflicts=FALSE)
df = tbl(src_sqlite("../data/cms.db"), "cms")
top_200 = df %>% mutate(Drug = generic_name) %>% group_by(Drug) %>% 
    summarize(Cost = sum(drug_cost),
              Beneficiaries = sum(bene_count),
              Claims = sum(claim_count)) %>% 
    arrange(desc(Claims))
top_200_claim = collect(top_200)[1:200,]
# Plot drug, claim, beneficiariy, cost
drug_cost = rPlot(Cost ~ Beneficiaries, data = top_200, size="Claims", type="point",
    tooltip="#!function(item){return item.Drug}!#")
drug_cost$set(title="Medicare Drug Claims: Top 200 by Claims, 2013")
drug_cost$addControls("x", value="Beneficiaries", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$addControls("y", value="Cost", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$addControls("size", value="Claims", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$save("./figures/drug-cost.html", standalone=TRUE)
top_200_claim
drug_cost = rPlot(Cost ~ Beneficiaries, data = top_200, size="Claims", type="point",
    tooltip="#!function(item){return item.Drug}!#")
head(top_200_claim)
drug_cost = rPlot(Cost ~ Beneficiaries, data = top_200_claim, size="Claims", type="point",
    tooltip="#!function(item){return item.Drug}!#")
drug_cost
drug_cost$set(title="Medicare Drug Claims: Top 200 by Claims, 2013")
drug_cost$addControls("x", value="Beneficiaries", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$addControls("y", value="Cost", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$addControls("size", value="Claims", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$save("./figures/drug-cost.html", standalone=TRUE)
drug_cost
top_200_cost = top_200 %>% arrange(desc(Cost))
top_200_cost = collect(top_200_cost)[1:200,]
drug_cost$save("./figures/drug-claim.html", standalone=TRUE)
drug_cost = rPlot(Cost ~ Beneficiaries, data = top_200_cost, size="Claims", type="point",
    tooltip="#!function(item){return item.Drug}!#")
drug_cost$set(title="Medicare Drug Claims: Top 200 by Claims, 2013")
drug_cost$addControls("x", value="Beneficiaries", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$addControls("y", value="Cost", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$addControls("size", value="Claims", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$save("./figures/drug-cost.html", standalone=TRUE)
drug_cost
drug_cost$set(color="red")
drug_cost
drug_colst$set(color = list(cont="red"))
drug_cost$set(color = list(cont="red"))
drug_cost
drug_cost = rPlot(Cost ~ Beneficiaries, data = top_200_cost, size="Claims", type="point", color=list(const="red"))
drug_cost
drug_cost = rPlot(Cost ~ Beneficiaries, data = top_200_cost, color="red", size="Claims", type="point",
    color=list(const="red"), tooltip="#!function(item){return item.Drug}!#")
drug_cost$set(title="Medicare Drug Claims: Top 200 by Total Cost, 2013")
drug_cost$addControls("x", value="Beneficiaries", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$addControls("y", value="Cost", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$addControls("size", value="Claims", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$save("./figures/drug-cost.html", standalone=TRUE)
drug_cost
drug_cost = rPlot(Cost ~ Beneficiaries, data = top_200_claim, size="Claims", type="point",
    tooltip="#!function(item){return item.Drug}!#")
drug_cost$set(title="Medicare Drug Claims: Top 200 by Claims, 2013")
drug_cost$addControls("x", value="Beneficiaries", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$addControls("y", value="Cost", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$addControls("size", value="Claims", values=c("Beneficiaries", "Cost", "Claims"))
drug_cost$save("./figures/drug-claim.html", standalone=TRUE)
drug_cost
top_spec = df %>% mutate(Drug = generic_name) %>% group_by(specialty) %>% summarize(cnt = n()) %>% arrange(desc(cn
top_spec = collect(top_spec)[1:20,]
top_spec = df %>% mutate(Drug = generic_name) %>% group_by(specialty) %>% summarize(cnt = n()) %>% arrange(desc(cnt))
top_spec = collect(top_spec)[1:20,]
colnames(df)
top_drug_state = df %>% mutate(Drug = drug_name, State = state) %>% group_by(state, Drug) %>%
    summarize(Cost = sum(drug_cost),
              Beneficiaries = sum(bene_count),
              Claims = sum(claim_count)) 
top_drug_state_cost = collect(top_drug_state %>% arrange(desc(Cost)))[1:200,]
top_drug_state_claim = collect(top_drug_state %>% arrange(desc(Claim)))[1:200,]
drug_state_cost = nPlot(Cost ~ Claim, data=top_drug_state_claim, group="State", color="Drug")
drug_state_cost = nPlot(Cost ~ Claims, data=top_drug_state_claim, group="State", color="Drug")
drug_state_cost
nPlot(Cost ~ Claims, data=top_drug_state_claim)
nPlot(Cost ~ Claims, data=top_drug_state_claim, type="scatterChart")
nPlot(Cost ~ Claims, data=top_drug_state_claim, type="scatterChart",
group="State")
nPlot(Cost ~ Claims, data=top_drug_state_claim, type="scatterChart",
group="State")
head(top_drug_state_claim)
nPlot(Cost ~ Claims, data=top_drug_state_claim, type="scatterChart",
group="state")
top_200_drugs = df %>% mutate(Drug = drug_name) %>% summarize(cnt=n()) %>% arrange(desc(n))
top_200_drugs = collect(top_200_drugs)[1:200,1]
top_200_drugs = df %>% mutate(Drug = drug_name) %>% summarize(cnt=n()) %>% arrange(desc(n))
top_200_drugs = collect(top_200_drugs)[1:200,1]
top_200_drugs = df %>% mutate(Drug = drug_name) %>% summarize(cnt=n()) %>% arrange(desc(cnt))
top_200_drugs = collect(top_200_drugs)[1:200,1]
top_200_drugs
top_200_drugs = df %>% mutate(Drug = drug_name) %>% summarize(cnt=n()) %>% arrange(desc(cnt))
top_200_drugs = collect(top_200_drugs)$Drug[1:200]
top_200_drugs
top_200_drugs = df %>% mutate(Drug = drug_name) %>% group_by(Drug) %>% summarize(cnt=n()) %>% arrange(desc(cnt))
top_200_drugs = collect(top_200_drugs)$Drug[1:200]
top_200_drugs
top_drug_state_cost = collect(top_drug_state %>% filter(Drug %in% top_200_drugs) %>% arrange(desc(Cost)))
top_drug_state_claim = collect(top_drug_state %>% filter(Drug %in% top_200_drugs) %>% arrange(desc(Claim)))
dim(top_drug_state)
dim(top_drug_state_claim)
nPlot(Cost ~ Claims, data=top_drug_state_claim, type="scatterChart", group="state")
colnames(top_drug_state_claim)
top_drug_state_claim = collect(top_drug_state %>% filter(Drug %in% top_200_drugs[1:50]) %>% arrange(desc(Claim)))
rPlot(state ~ Drug, data = top_drug_state_claim, color="Cost", type="tile")
top_drug_state = df %>% mutate(Drug = drug_name, State = state) %>% 
    group_by(State) %>%
    mutate(total_drug_cost = sum(Cost)) %>%
    group_by(State, Drug) %>%
    summarize(Cost = sum(drug_cost) / total_drug_cost,
              Beneficiaries = sum(bene_count),
              Claims = sum(claim_count))
top_drug_state
top_by_drug_state = df %>% mutate(Drug = drug_name, State = state) %>%
    filter(Drug %in% top_200_drugs) %>%
    group_by(State) %>%
    mutate(total_drug_cost = sum(Cost)) %>%
    group_by(State, Drug) %>%
    summarize(Cost = sum(drug_cost) / total_drug_cost,
              Beneficiaries = sum(bene_count),
              Claims = sum(claim_count))
top_drug_by_state = collect(top_by_drug_state)
dim(top_drug_state)
dim(top_drug_by_state)
top_drug_by_state
top_200_drugs
top_drug_by_state = df %>% mutate(Drug = drug_name, State = state) %>%
    filter(Drug %in% top_200_drugs) %>%
    group_by(State) %>%
    mutate(total_drug_cost = sum(drug_cost)) %>%
    group_by(State, Drug) %>%
    summarize(Cost = sum(drug_cost) / total_drug_cost,
              Beneficiaries = sum(bene_count),
              Claims = sum(claim_count))
top_drug_by_state = collect(top_drug_by_state)
dim(top_drug_by_state)
top_drug_by_state = df %>% mutate(Drug = drug_name, State = state) %>%
    group_by(State) %>%
    mutate(total_drug_cost = sum(drug_cost)) %>%
    filter(Drug %in% top_200_drugs) %>%
    group_by(State, Drug) %>%
    summarize(Cost = sum(drug_cost) / mean(total_drug_cost),
              Beneficiaries = sum(bene_count),
              Claims = sum(claim_count))
top_drug_by_state$query
top_drug_by_state = collect(top_drug_by_state)
dim(top_drug_by_state)
top_drug_by_state = df %>% mutate(Drug = drug_name, State = state) %>%
    group_by(State) %>%
    mutate(total_drug_cost = sum(drug_cost)) %>%
    ungroup() %>%
    filter(Drug %in% top_200_drugs) %>%
    group_by(State, Drug) %>%
    summarize(Cost = sum(drug_cost) / mean(total_drug_cost),
              Beneficiaries = sum(bene_count),
              Claims = sum(claim_count))
top_drug_by_state = collect(top_drug_by_state)
dim(top_drug_by_state)
